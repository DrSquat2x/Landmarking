<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to use the R package 'Landmarking' • Landmarking</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How to use the R package 'Landmarking'">
<meta property="og:description" content="Landmarking">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Landmarking</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/Landmarking.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/how_to_use.html">How to use the R package 'Landmarking'</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/isobelbarrott/Landmarking/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="how_to_use_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How to use the R package ‘Landmarking’</h1>
                        <h4 class="author">Isobel Barrott</h4>
            
            <h4 class="date">26th July 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/isobelbarrott/Landmarking/blob/master/vignettes/how_to_use.Rmd"><code>vignettes/how_to_use.Rmd</code></a></small>
      <div class="hidden name"><code>how_to_use.Rmd</code></div>

    </div>

    
    
<p>##Performing a landmarking analysis using the R package ‘Landmarking’</p>
<p>Below is a step-by-step demonstration about how to use this package. The example used looks at using risk assessments recorded at primary care practices to predict the 5-year risk of cardiovascular disease (CVD).</p>
<p>We will perform the landmarking analysis using both the LOCF and LME longitudinal models and compare the results of these two models. The example involves a competing risks events in the form of the risk of death from other causes; the cause-specific model will as used the survival submodel. For more information about these models please see the separate `What is Landmarking?’ PDF file.</p>
<div id="exploring-the-datasets" class="section level3">
<h3 class="hasAnchor">
<a href="#exploring-the-datasets" class="anchor"></a>Exploring the datasets</h3>
<p>First of all, let’s take a look at the datasets we are going to analyse.</p>
<p>There are two datasets:</p>
<ul>
<li><p><code>data_repeats</code> contains repeat measurements data from CVD risk assessments in long format. Each row corresponds to a different assessment and an individual may have multiple assessments. The dataset contains information about an individual’s ethnicity, smoking status, diabetes, and standardised systolic blood pressure (SBP). These were recorded on the date specified in <code>response_date_sbp_stnd</code>. The standardised total cholesterol to high density lipoprotein (HDL) ratio was also recorded as part of the assessment but was recorded on the date specified in <code>response_date_tchdl_stnd</code>, which is up to a month after the other variables were measured.</p></li>
<li><p><code>data_outcomes</code> contains CVD event data, indicating the time and status of event that each individual experiences. There are three types of events: censoring (this is due to loss to follow-up or the end of the study, indicated by status <code>0</code>), CVD event (indicated by status <code>1</code>), or death from other causes (indicated by status <code>2</code>). It is important when using this package that 0 is used to indicate censoring, 1 to indicate the event of interest, and values 2 or above indicate different competing risks.</p></li>
</ul>
<p>Both datasets contain column <code>id</code> which specifies the patient identifier which is unique to a patient.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/isobelbarrott/Landmarking">Landmarking</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">data_repeat</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data_repeat</span><span class="op">)</span>
<span class="co">#&gt;   id smoking diabetes ethnicity deprivation        dob index</span>
<span class="co">#&gt; 1  1       0        0  European           2 1942-10-07     1</span>
<span class="co">#&gt; 2  1       0        0  European           2 1942-10-07     2</span>
<span class="co">#&gt; 3  1       0        0  European           2 1942-10-07     3</span>
<span class="co">#&gt; 4  1       0        0  European           2 1942-10-07     4</span>
<span class="co">#&gt; 5  2       0        0  European           1 1942-05-10     1</span>
<span class="co">#&gt; 6  3       1        0  European           5 1944-06-10     1</span>
<span class="co">#&gt;   response_date_sbp_stnd    sbp_stnd response_date_tchdl_stnd tchdl_stnd</span>
<span class="co">#&gt; 1             2000-09-30 -1.32031272               2000-10-19 -0.6701369</span>
<span class="co">#&gt; 2             2000-04-12 -0.79339073               2000-04-26 -1.1694297</span>
<span class="co">#&gt; 3             2001-11-01 -1.49207104               2001-11-29 -0.6655325</span>
<span class="co">#&gt; 4             2003-12-13 -0.04093651               2003-12-18 -0.6756338</span>
<span class="co">#&gt; 5             2007-11-14 -0.70343579               2007-11-28 -1.0776750</span>
<span class="co">#&gt; 6             2007-06-13  0.86883763               2007-06-28 -0.7842055</span>
<span class="co">#&gt;   end_of_study_age response_time_tchdl_stnd response_time_sbp_stnd</span>
<span class="co">#&gt; 1         71.23340                 58.03422               57.98220</span>
<span class="co">#&gt; 2         71.23340                 57.55236               57.51403</span>
<span class="co">#&gt; 3         71.23340                 59.14579               59.06913</span>
<span class="co">#&gt; 4         71.23340                 61.19644               61.18275</span>
<span class="co">#&gt; 5         71.64408                 65.55236               65.51403</span>
<span class="co">#&gt; 6         69.55784                 63.04723               63.00616</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">data_outcomes</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data_outcomes</span><span class="op">)</span>
<span class="co">#&gt;   id event_status event_time</span>
<span class="co">#&gt; 1  1            0   63.12263</span>
<span class="co">#&gt; 2  2            0   71.64408</span>
<span class="co">#&gt; 3  3            0   63.17899</span>
<span class="co">#&gt; 4  4            0   73.52498</span>
<span class="co">#&gt; 5  5            0   64.72005</span>
<span class="co">#&gt; 6  6            0   62.23649</span></code></pre></div>
<p>Looking further at these datasets we see that there are 3000 patients in this study, each with an average of 3.016 assessments.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_repeat</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> 
<span class="co">#&gt; [1] 3000</span>
<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_repeat</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.016</span></code></pre></div>
<p>Moreover, we can see the breakdown of events</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_outcomes</span><span class="op">$</span><span class="va">event_status</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;    0    1    2 </span>
<span class="co">#&gt; 2872   93   35</span></code></pre></div>
<p>So 93 patients in the study (out of 3000 experienced a CVD event and 35 experienced death from other causes.</p>
<p>###Setting up the analysis</p>
<p>To use the Landmarking package, the datasets need to be in a certain format. Firstly, instead of the date of the CVD assessment being recorded, the age of the patient should be recorded. These can be calculated as follows.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_repeat</span><span class="op">$</span><span class="va">response_time_tchdl_stnd</span><span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">data_repeat</span><span class="op">$</span><span class="va">response_date_tchdl_stnd</span>,format<span class="op">=</span><span class="st">"yyyy-mm-dd"</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">data_repeat</span><span class="op">$</span><span class="va">dob</span>,format<span class="op">=</span><span class="st">"yyyy-mm-dd"</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">365.25</span><span class="op">)</span>
<span class="va">data_repeat</span><span class="op">$</span><span class="va">response_time_sbp_stnd</span><span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">data_repeat</span><span class="op">$</span><span class="va">response_date_sbp_stnd</span>,format<span class="op">=</span><span class="st">"yyyy-mm-dd"</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">data_repeat</span><span class="op">$</span><span class="va">dob</span>,format<span class="op">=</span><span class="st">"yyyy-mm-dd"</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">365.25</span><span class="op">)</span></code></pre></div>
<p>We also need to define a time of entry into the study and time of exit from the study for each patient. This is necessary in order to work out which individuals are in the risk set at the landmark time. For this study the time of entry into the study is the date of first assessment for an individual. This is the earliest time of <code>response_time_sbp_stnd</code> and can be calculated as:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start_time</span><span class="op">&lt;-</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"response_time_sbp_stnd"</span>,<span class="st">"~"</span>,<span class="st">"id"</span><span class="op">)</span><span class="op">)</span>,<span class="va">data_repeat</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">start_time</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"start_time"</span>
<span class="va">data_repeat</span><span class="op">&lt;-</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_repeat</span>,<span class="va">start_time</span>,by<span class="op">=</span><span class="st">"id"</span><span class="op">)</span></code></pre></div>
<p>The patient exits the study either by having an event or being censored at the end of the study on 1st January 2010. All individuals have been censored after this date in the dataset <code>data_outcome</code>. The end of study time is therefore simply the <code>event_time</code> column.</p>
<p>Finally, the package Landmarking requires that both datasets are joined into one.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_repeat_outcomes</span><span class="op">&lt;-</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_repeat</span>,<span class="va">data_outcomes</span>,by<span class="op">=</span><span class="st">"id"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data_repeat_outcomes</span><span class="op">)</span>
<span class="co">#&gt;   id smoking diabetes ethnicity deprivation        dob index</span>
<span class="co">#&gt; 1  1       0        0  European           2 1942-10-07     1</span>
<span class="co">#&gt; 2  1       0        0  European           2 1942-10-07     2</span>
<span class="co">#&gt; 3  1       0        0  European           2 1942-10-07     3</span>
<span class="co">#&gt; 4  1       0        0  European           2 1942-10-07     4</span>
<span class="co">#&gt; 5  2       0        0  European           1 1942-05-10     1</span>
<span class="co">#&gt; 6  3       1        0  European           5 1944-06-10     1</span>
<span class="co">#&gt;   response_date_sbp_stnd    sbp_stnd response_date_tchdl_stnd tchdl_stnd</span>
<span class="co">#&gt; 1             2000-09-30 -1.32031272               2000-10-19 -0.6701369</span>
<span class="co">#&gt; 2             2000-04-12 -0.79339073               2000-04-26 -1.1694297</span>
<span class="co">#&gt; 3             2001-11-01 -1.49207104               2001-11-29 -0.6655325</span>
<span class="co">#&gt; 4             2003-12-13 -0.04093651               2003-12-18 -0.6756338</span>
<span class="co">#&gt; 5             2007-11-14 -0.70343579               2007-11-28 -1.0776750</span>
<span class="co">#&gt; 6             2007-06-13  0.86883763               2007-06-28 -0.7842055</span>
<span class="co">#&gt;   end_of_study_age response_time_tchdl_stnd response_time_sbp_stnd start_time</span>
<span class="co">#&gt; 1         71.23340                 58.03422               57.98220   57.51403</span>
<span class="co">#&gt; 2         71.23340                 57.55236               57.51403   57.51403</span>
<span class="co">#&gt; 3         71.23340                 59.14579               59.06913   57.51403</span>
<span class="co">#&gt; 4         71.23340                 61.19644               61.18275   57.51403</span>
<span class="co">#&gt; 5         71.64408                 65.55236               65.51403   65.51403</span>
<span class="co">#&gt; 6         69.55784                 63.04723               63.00616   57.12526</span>
<span class="co">#&gt;   event_status event_time</span>
<span class="co">#&gt; 1            0   63.12263</span>
<span class="co">#&gt; 2            0   63.12263</span>
<span class="co">#&gt; 3            0   63.12263</span>
<span class="co">#&gt; 4            0   63.12263</span>
<span class="co">#&gt; 5            0   71.64408</span>
<span class="co">#&gt; 6            0   63.17899</span></code></pre></div>
<p>We are now ready to begin the analysis using the Landmarking package.</p>
</div>
<div id="landmarking-analysis-using-the-package" class="section level2">
<h2 class="hasAnchor">
<a href="#landmarking-analysis-using-the-package" class="anchor"></a>Landmarking analysis using the package</h2>
<p>There are a couple of issues to deal with before we start, these stem from the fact that we wish to compare the LOCF and LME longitudinal model. We want to ensure that the same dataset is used for both of these models so that the comparison is fair.</p>
<p>The first issue is that the presence of <code>NA</code> values means that some individuals in the risk set do not have LOCF values for all the covariates. This means that the LOCF longitudinal model cannot be fitted for these individuals, however the LME longitudinal model can allow missing values in the random effects covariates. As we wish that the dataset that both models are fitted are the same, we should consider removing these individuals from the dataset.</p>
<p>Helpfully, the <code>Landmarking</code> package contains a function <code>return_ids_with_LOCF</code> to create a dataset with individuals with a LOCF for all covariates contained in the <code>covariates</code> parameter at landmark time <code>x_L</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_repeat_outcomes</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/return_ids_with_LOCF.html">return_ids_with_LOCF</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">data_repeat_outcomes</span>,patient_id<span class="op">=</span><span class="st">"id"</span>,covariates<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ethnicity"</span>,<span class="st">"smoking"</span>,<span class="st">"diabetes"</span>,<span class="st">"sbp_stnd"</span>,<span class="st">"tchdl_stnd"</span><span class="op">)</span>,covariates_time<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"response_time_sbp_stnd"</span>,<span class="fl">4</span><span class="op">)</span>,<span class="st">"response_time_tchdl_stnd"</span><span class="op">)</span>,x_L<span class="op">=</span><span class="fl">60</span><span class="op">)</span></code></pre></div>
<p>The second issue is to do with cross-validation, but we will deal with this once we have fitted the LOCF landmark model.</p>
<p>So we can now fit the landmark model using the LOCF longitudinal submodel. To demonstrate how to use the package, we use only landmark times 60 and 61 years old however we may wish to use more landmark times in practice. For more information about this function, see the Details section of the <code>fit_LOCF_landmark_model</code> documentation.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_model_landmark_LOCF</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/fit_LOCF_landmark_model.html">fit_LOCF_landmark_model</a></span><span class="op">(</span>data_long<span class="op">=</span><span class="va">data_repeat_outcomes</span>,
                                                  x_L<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">60</span>,<span class="fl">61</span><span class="op">)</span>,
                                                  x_hor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">65</span>,<span class="fl">66</span><span class="op">)</span>, 
                                                  covariates<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ethnicity"</span>,<span class="st">"smoking"</span>,<span class="st">"diabetes"</span>,<span class="st">"sbp_stnd"</span>,<span class="st">"tchdl_stnd"</span><span class="op">)</span>,
                                                  covariates_time<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"response_time_sbp_stnd"</span>,<span class="fl">4</span><span class="op">)</span>,<span class="st">"response_time_tchdl_stnd"</span><span class="op">)</span>,
                                                  k<span class="op">=</span><span class="fl">10</span>,
                                                  start_study_time<span class="op">=</span><span class="st">"start_time"</span>,
                                                  end_study_time<span class="op">=</span><span class="st">"event_time"</span>,
                                                  patient_id<span class="op">=</span><span class="st">"id"</span>,
                                                  event_time<span class="op">=</span><span class="st">"event_time"</span>,
                                                  event_status<span class="op">=</span><span class="st">"event_status"</span>,
                                                  survival_submodel <span class="op">=</span> <span class="st">"cause_specific"</span>
                                                  <span class="op">)</span>
<span class="co">#&gt; [1] "Fitting longitudinal submodel, landmark age 60"</span>
<span class="co">#&gt; [1] "Complete, landmark age 60"</span>
<span class="co">#&gt; [1] "Fitting survival submodel, landmark age 60"</span>
<span class="co">#&gt; Warning in coxph.fit(X, Y, istrat, offset, init, control, weights = weights, :</span>
<span class="co">#&gt; Loglik converged before variable 2 ; coefficient may be infinite.</span>
<span class="co">#&gt; [1] "Complete, landmark age 60"</span>
<span class="co">#&gt; [1] "Fitting longitudinal submodel, landmark age 61"</span>
<span class="co">#&gt; [1] "Complete, landmark age 61"</span>
<span class="co">#&gt; [1] "Fitting survival submodel, landmark age 61"</span>
<span class="co">#&gt; Warning in coxph.fit(X, Y, istrat, offset, init, control, weights = weights, :</span>
<span class="co">#&gt; Loglik converged before variable 2 ; coefficient may be infinite.</span>
<span class="co">#&gt; [1] "Complete, landmark age 61"</span></code></pre></div>
<p>We can see that fitting this model returns the warnings such as <code>Loglik converged before variable  2 ; coefficient may be infinite.</code>. Taking a look at the model fit contained in <code>data_model_landmark_LOCF$model_survival</code>, we can see the upper confidence interval for <code>ethnicityIndian</code> is <code>inf</code> for certain folds. This is due there being few individuals that have ethnicity ‘Indian’ and few individuals that experienced death from other causes. However, as only the point estimate of the coefficient is needed to calculate the risk prediction, not having the standard error is not a problem. Indeed we have obtained the risk predictions and can take a look at their distribution.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="va">data_model_landmark_LOCF</span><span class="op">[[</span><span class="st">"60"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">event_prediction</span><span class="op">)</span>, xlab<span class="op">=</span><span class="st">"Predicted risk of CVD event (%)"</span>,main<span class="op">=</span><span class="st">"Landmark age 60"</span><span class="op">)</span></code></pre></div>
<p><img src="how_to_use_files/figure-html/12-1.png" width="700"></p>
<p>Printing the object that has been outputted returns a list of datasets corresponding to each of the landmark groups. These contain the column <code>event_prediction</code> which indicates the risk prediction of the event of interest.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_model_landmark_LOCF</span>
<span class="co">#&gt; $`60`</span>
<span class="co">#&gt;   id smoking diabetes           ethnicity   sbp_stnd tchdl_stnd</span>
<span class="co">#&gt; 1  1       0        0            European -1.4920710 -0.6655325</span>
<span class="co">#&gt; 2  3       1        0            European -1.3437038 -0.3685394</span>
<span class="co">#&gt; 3  5       0        0            European -0.6875824  1.0225489</span>
<span class="co">#&gt; 4  6       0        0             Pacific -0.2432283  0.3827371</span>
<span class="co">#&gt; 5  8       1        0 Chinese_other_asian  0.1512618 -1.8789467</span>
<span class="co">#&gt; 6  9       1        0 Chinese_other_asian -0.6250009 -0.8955987</span>
<span class="co">#&gt;   cross_validation_number event_status event_time event_prediction</span>
<span class="co">#&gt; 1                       6            0   63.12263       0.03365832</span>
<span class="co">#&gt; 2                       9            0   63.17899       0.07872681</span>
<span class="co">#&gt; 3                       9            0   64.72005       0.04809597</span>
<span class="co">#&gt; 4                       9            0   62.23649       0.04971934</span>
<span class="co">#&gt; 5                       3            0   64.71262       0.04538648</span>
<span class="co">#&gt; 6                      10            0   65.00000       0.05864612</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`61`</span>
<span class="co">#&gt;   id smoking diabetes           ethnicity   sbp_stnd tchdl_stnd</span>
<span class="co">#&gt; 1  1       0        0            European -1.4920710 -0.6655325</span>
<span class="co">#&gt; 2  3       1        0            European -1.3437038 -0.3685394</span>
<span class="co">#&gt; 3  5       0        0            European -0.6875824  1.0225489</span>
<span class="co">#&gt; 4  6       0        0             Pacific -0.2432283  0.3827371</span>
<span class="co">#&gt; 5  8       1        0 Chinese_other_asian  0.1512618 -1.8789467</span>
<span class="co">#&gt; 6  9       1        0 Chinese_other_asian -0.6250009 -0.8955987</span>
<span class="co">#&gt;   cross_validation_number event_status event_time event_prediction</span>
<span class="co">#&gt; 1                       6            0   63.12263       0.03261120</span>
<span class="co">#&gt; 2                       9            0   63.17899       0.07406992</span>
<span class="co">#&gt; 3                       9            0   64.72005       0.03971994</span>
<span class="co">#&gt; 4                       9            0   62.23649       0.04202924</span>
<span class="co">#&gt; 5                       3            0   64.71262       0.05218852</span>
<span class="co">#&gt; 6                      10            0   65.68098       0.06160581</span></code></pre></div>
<p>The output also contains the prediction error for the model, which is assessed using the Brier score and c-index. The standard error for these estimates can be calculated by setting parameter <code>b</code> to the desired number of bootstrap samples.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_model_landmark_LOCF</span><span class="op">[[</span><span class="st">"60"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">prediction_error</span>
<span class="co">#&gt; $c_index</span>
<span class="co">#&gt; [1] 0.5843387</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $c_index_standard_error</span>
<span class="co">#&gt; [1] NA</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $brier_score</span>
<span class="co">#&gt; [1] 0.05446934</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $brier_score_standard_error</span>
<span class="co">#&gt; [1] NA</span>
<span class="va">data_model_landmark_LOCF</span><span class="op">[[</span><span class="st">"61"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">prediction_error</span>
<span class="co">#&gt; $c_index</span>
<span class="co">#&gt; [1] 0.553123</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $c_index_standard_error</span>
<span class="co">#&gt; [1] NA</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $brier_score</span>
<span class="co">#&gt; [1] 0.05643429</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $brier_score_standard_error</span>
<span class="co">#&gt; [1] NA</span></code></pre></div>
<p>Now we can move on to fitting the landmark model using the LME longitudinal submodel. For more information about this function, see the Details section of the <code>fit_LME_landmark_model</code> documentation. The variables standardised systolic blood pressure (SBP) and standardised total cholesterol to high density lipoprotein (HDL) ratio are continuous and repeatedly measured and so these are included as random effects in the LME model.</p>
<p>The second issue which was mentioned previously is related to cross-validation. In particular we wish to perform k-fold cross-validation using exactly the same folds for both LOCF and LME models to ensure a fair comparison. To do this we use the parameter <code>cross_validation_df</code> which uses a list of data frames that indicate which fold each individual belongs to. We create this list using the output of <code>fit_LOCF_landmark_model</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cross_validation_list</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">data_model_landmark_LOCF</span>,<span class="st">"[["</span>,i<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>There are a couple of computational considerations to highlight about fitting the LME model. The parameter <code>lme_control</code> can be altered in order to change the default values of parameters (such as maximum number of iterations) for the algorithm which fits the LME model. Also setting <code>standardise_time = TRUE</code> standardises time values which helps fitting the LME model (see <code><a href="../reference/fit_LME_landmark_model.html">help("fit_LME_landmark_model")</a></code>).</p>
<p>So we fit the LME landmark model in a similar way to the LOCF landmark model, but with a few extra parameters.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_model_landmark_LME</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/fit_LME_landmark_model.html">fit_LME_landmark_model</a></span><span class="op">(</span>data_long<span class="op">=</span><span class="va">data_repeat_outcomes</span>,
                                                  x_L<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">60</span>,<span class="fl">61</span><span class="op">)</span>,
                                                  x_hor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">65</span>,<span class="fl">66</span><span class="op">)</span>,
                                                  cross_validation_df<span class="op">=</span><span class="va">cross_validation_list</span>,
                                                  start_study_time<span class="op">=</span><span class="st">"start_time"</span>,
                                                  end_study_time<span class="op">=</span><span class="st">"event_time"</span>,
                                                    fixed_effects<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ethnicity"</span>,<span class="st">"smoking"</span>,<span class="st">"diabetes"</span><span class="op">)</span>,
                                                    fixed_effects_time<span class="op">=</span><span class="st">"response_time_sbp_stnd"</span>,
                                                    random_effects<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sbp_stnd"</span>,<span class="st">"tchdl_stnd"</span><span class="op">)</span>,
                                                    random_effects_time<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"response_time_sbp_stnd"</span>,<span class="st">"response_time_tchdl_stnd"</span><span class="op">)</span>,
                                                    patient_id<span class="op">=</span><span class="st">"id"</span>,
                                                    standardise_time <span class="op">=</span> <span class="cn">TRUE</span>,
                                                    lme_control <span class="op">=</span> <span class="fu">nlme</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/lmeControl.html">lmeControl</a></span><span class="op">(</span>maxIter<span class="op">=</span><span class="fl">100</span>,msMaxIter<span class="op">=</span><span class="fl">100</span><span class="op">)</span>,
                                                    event_time<span class="op">=</span><span class="st">"event_time"</span>,
                                                    event_status<span class="op">=</span><span class="st">"event_status"</span>,
                                                    survival_submodel <span class="op">=</span> <span class="st">"cause_specific"</span><span class="op">)</span>
<span class="co">#&gt; [1] "Fitting longitudinal submodel, landmark age 60"</span>
<span class="co">#&gt; [1] "Complete, landmark age 60"</span>
<span class="co">#&gt; [1] "Fitting survival submodel, landmark age 60"</span>
<span class="co">#&gt; Warning in coxph.fit(X, Y, istrat, offset, init, control, weights = weights, :</span>
<span class="co">#&gt; Loglik converged before variable 2 ; coefficient may be infinite.</span>
<span class="co">#&gt; [1] "Complete, landmark age 60"</span>
<span class="co">#&gt; [1] "Fitting longitudinal submodel, landmark age 61"</span>
<span class="co">#&gt; [1] "Complete, landmark age 61"</span>
<span class="co">#&gt; [1] "Fitting survival submodel, landmark age 61"</span>
<span class="co">#&gt; Warning in coxph.fit(X, Y, istrat, offset, init, control, weights = weights, :</span>
<span class="co">#&gt; Loglik converged before variable 2 ; coefficient may be infinite.</span>
<span class="co">#&gt; [1] "Complete, landmark age 61"</span></code></pre></div>
<p>Comparing the prediction error for the landmarking with LOCF and LME, we can see a slight improvement when the LME model is used.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_model_landmark_LME</span><span class="op">[[</span><span class="st">"60"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">prediction_error</span>
<span class="co">#&gt; $c_index</span>
<span class="co">#&gt; [1] 0.5745881</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $c_index_standard_error</span>
<span class="co">#&gt; [1] NA</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $brier_score</span>
<span class="co">#&gt; [1] 0.05453336</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $brier_score_standard_error</span>
<span class="co">#&gt; [1] NA</span>
<span class="va">data_model_landmark_LME</span><span class="op">[[</span><span class="st">"61"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">prediction_error</span>
<span class="co">#&gt; $c_index</span>
<span class="co">#&gt; [1] 0.5606953</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $c_index_standard_error</span>
<span class="co">#&gt; [1] NA</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $brier_score</span>
<span class="co">#&gt; [1] 0.0563937</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $brier_score_standard_error</span>
<span class="co">#&gt; [1] NA</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Isobel Barrott, Jessica Barrett.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
